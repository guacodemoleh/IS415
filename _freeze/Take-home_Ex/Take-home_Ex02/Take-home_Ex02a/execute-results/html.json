{
  "hash": "3447caf83ff0a55cad1b6602d75dff13",
  "result": {
    "markdown": "---\ntitle: \"Take-home Exercise 2: Application of Spatial and Spatio-temporal Analysis Methods to Discover the Distribution of Dengue Fever in Tainan City, Taiwan\"\nauthor: \"Victoria Grace ANN\"\nexecute: \n  warning: false\n  eval: true\n  echo: true\n  freeze: true\nformat:  \n  html: \n    code-summary: \"Show the code\"\n    toc-depth: 4\ndate: \"14 February, 2024\"\ndate-modified: \"last-modified\"\neditor: visual\n---\n\n\n# Overview\n\nDengue fever is a ubiquitous condition in tropical areas characterised by humid weather induced by warm temperatures and abundant rainfall. Taiwan is a subtropical region and its weather conditions cause it to be a favourable breeding ground for female Aedes aegypti and Aedes albopictus mosquitoes.\n\nIn 2015, Taiwan In 2015, Taiwan had recorded the most severe dengue fever outbreak with more than 43,000 dengue cases and 228 deaths. Since then, the annual reported dengue fever cases were maintained at the level of not more than 200 cases. However, in 2023, Taiwan recorded 26703 dengue fever cases (Kam, 2024).\n\nFor this project, the study area focuses on Southwest Tainan, and epidemiology weeks 31 through 50 in 2023.\n\n# Getting Started\n\n## Loading necessary packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, lubridate, dplyr, sf, tmap, sfdep, gifski, Kendall, cowplot)\n```\n:::\n\n\n## Importing data\n\n### Geospatial\n\nRead the Tainan boundary layer.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntn_sf <- st_read(\"data/geospatial/TAINAN_VILLAGE.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `TAINAN_VILLAGE' from data source \n  `C:\\guacodemoleh\\IS415-GAA\\Take-home_Ex\\Take-home_Ex02\\data\\geospatial\\TAINAN_VILLAGE.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 649 features and 10 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 120.0269 ymin: 22.88751 xmax: 120.6563 ymax: 23.41374\nGeodetic CRS:  TWD97\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntn_sf <- st_transform(tn_sf, crs = 3824)\nplot(st_geometry(tn_sf))\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n::: {callout-note}\nThe coordinates are employing the TWD97 geodetic system, which translates to EPSG ID 3824.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(tn_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   VILLCODE          COUNTYNAME          TOWNNAME           VILLNAME        \n Length:649         Length:649         Length:649         Length:649        \n Class :character   Class :character   Class :character   Class :character  \n Mode  :character   Mode  :character   Mode  :character   Mode  :character  \n   VILLENG            COUNTYID          COUNTYCODE           TOWNID         \n Length:649         Length:649         Length:649         Length:649        \n Class :character   Class :character   Class :character   Class :character  \n Mode  :character   Mode  :character   Mode  :character   Mode  :character  \n   TOWNCODE             NOTE                    geometry  \n Length:649         Length:649         POLYGON      :649  \n Class :character   Class :character   epsg:3824    :  0  \n Mode  :character   Mode  :character   +proj=long...:  0  \n```\n:::\n:::\n\n\n### Aspatial\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_csv(\"data/aspatial/Dengue_Daily.csv\")\n```\n:::\n\n\n# Confining Data to Study Area and Time Period\n\n## Tainan Geospatial Data\n\nThis project will focus towns with IDs D01, D02, D04, D06, D07, D08, D36, D39.\n\nHence, confine the geospatial data to the study area,\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntainan_aoi <- tn_sf %>%\n  filter(TOWNID %in% c(\"D01\", \"D02\", \"D04\", \"D06\", \"D07\", \"D08\", \"D32\", \"D39\"))\n\nsummary(tainan_aoi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   VILLCODE          COUNTYNAME          TOWNNAME           VILLNAME        \n Length:258         Length:258         Length:258         Length:258        \n Class :character   Class :character   Class :character   Class :character  \n Mode  :character   Mode  :character   Mode  :character   Mode  :character  \n   VILLENG            COUNTYID          COUNTYCODE           TOWNID         \n Length:258         Length:258         Length:258         Length:258        \n Class :character   Class :character   Class :character   Class :character  \n Mode  :character   Mode  :character   Mode  :character   Mode  :character  \n   TOWNCODE             NOTE                    geometry  \n Length:258         Length:258         POLYGON      :258  \n Class :character   Class :character   epsg:3824    :  0  \n Mode  :character   Mode  :character   +proj=long...:  0  \n```\n:::\n:::\n\n\nView how the different towns are located geographically by using a choropleth map via **tmap**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstudy_townids <- c(\"D01\", \"D02\", \"D04\", \"D06\", \"D07\", \"D08\", \"D32\", \"D39\")\n\ntn_sf_filtered <- tn_sf %>%\n  mutate(highlight = ifelse(TOWNID %in% study_townids, \"Study\", \"Not Study\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmain_map <- tm_shape(tn_sf_filtered) +\n  tm_polygons(\"highlight\", palette = c(\"grey\", \"red\")) +\n  tm_borders(lwd = 0.2, alpha = 1) +\n  tm_layout(main.title = \"Overview of Tainan\", main.title.size = 1) +\n  tm_scale_bar()\n\nsecondary_map <- tm_shape(tainan_aoi) +\n  tm_polygons(col = \"TOWNID\") +\n  tm_layout(legend.show = TRUE, main.title = \"Overview of Dengue Study Area\", main.title.size = 1) +\n  tm_scale_bar()\n\ntm_layout(legend.show = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$tm_layout\n$tm_layout$legend.show\n[1] FALSE\n\n$tm_layout$style\n[1] NA\n\n\nattr(,\"class\")\n[1] \"tm\"\n```\n:::\n\n```{.r .cell-code}\ntmap_arrange(main_map, secondary_map, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Dengue Data\n\nFirst, let's find out more about our dengue data.\n\nCheck the *class* type of the dengue data set.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"spec_tbl_df\" \"tbl_df\"      \"tbl\"         \"data.frame\" \n```\n:::\n:::\n\n\n-   Currently, the dengue data set is a tibble data frame.\n\nBrowse through the first few rows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 26\n  發病日     個案研判日 通報日     性別  年齡層 居住縣市 居住鄉鎮 居住村里\n  <date>     <chr>      <date>     <chr> <chr>  <chr>    <chr>    <chr>   \n1 1998-01-02 None       1998-01-07 男    40-44  屏東縣   屏東市   None    \n2 1998-01-03 None       1998-01-14 男    30-34  屏東縣   東港鎮   None    \n3 1998-01-13 None       1998-02-18 男    55-59  宜蘭縣   宜蘭市   None    \n4 1998-01-15 None       1998-01-23 男    35-39  高雄市   苓雅區   None    \n5 1998-01-20 None       1998-02-04 男    55-59  宜蘭縣   五結鄉   None    \n6 1998-01-22 None       1998-02-19 男    20-24  桃園市   蘆竹區   None    \n# ℹ 18 more variables: 最小統計區 <chr>, 最小統計區中心點X <chr>,\n#   最小統計區中心點Y <chr>, 一級統計區 <chr>, 二級統計區 <chr>,\n#   感染縣市 <chr>, 感染鄉鎮 <chr>, 感染村里 <chr>, 是否境外移入 <chr>,\n#   感染國家 <chr>, 確定病例數 <dbl>, 居住村里代碼 <chr>, 感染村里代碼 <chr>,\n#   血清型 <chr>, 內政部居住縣市代碼 <chr>, 內政部居住鄉鎮代碼 <chr>,\n#   內政部感染縣市代碼 <chr>, 內政部感染鄉鎮代碼 <chr>\n```\n:::\n:::\n\n\nThe data is in Traditional Chinese? No problem! The following table is a rough guide on all the attributes:\n\n| Attribute             | Translation                                       |\n|-------------------------|------------------------------------------------|\n| **發病日**            | **Onset date**                                    |\n| 個案研判日            | Assessed date                                     |\n| 通報日                | Notification date                                 |\n| 性別                  | Gender                                            |\n| 年齡層                | Age group                                         |\n| 居住縣市              | Residential city                                  |\n| 居住鄉鎮              | Residential township                              |\n| 居住村里              | Residential village                               |\n| 最小統計區            | Smallest statistical area                         |\n| **最小統計區中心點X** | **X-coordinate** of the smallest statistical area |\n| **最小統計區中心點Y** | **Y-coordinate** of the smallest statistical area |\n| 一級統計區            | Level 1 statistical area                          |\n| 二級統計區            | Level 2 statistical area                          |\n| 感染縣市              | Infected city                                     |\n| 感染鄉鎮              | Infected township                                 |\n| 感染村里              | Infected village                                  |\n| 是否境外移入          | Imported case?                                    |\n| 感染國家              | Imported country origin                           |\n| **確定病例數**        | **Confirmed case count**                          |\n| 居住村里代碼          | Residential village code                          |\n| 感染村里代碼          | Infected village code                             |\n| 血清型                | Serotype                                          |\n| 內政部居住縣市代碼    | Residential city (Internal Affairs)               |\n| 內政部居住鄉鎮代碼    | Residential township (Internal Affairs)           |\n| 內政部感染縣市代碼    | Infected city code (Internal Affairs)             |\n| 內政部感染鄉鎮代碼    | Infected township code (Internal Affairs)         |\n\nSince the data includes all of Taiwan's confirmed dengue cases from 1998 to January 2024, the data needs to be further confined to year 2023, epidemiology weeks 31 to 50.\n\nExtract all the 2023 dengue cases.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_2023 <- subset(dengue, substr(發病日, 1, 4) == \"2023\")\n```\n:::\n\n\nCreate a column to store the epidemiology week number for the respective dates. We can use a function called *epiweek()* from the [**lubridate**](https://lubridate.tidyverse.org/reference/week.html) package to carry this task out.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_2023$epi_week <- epiweek(dengue_2023$發病日)\n```\n:::\n\n\nFilter for epidemiology weeks 31 to 50.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_study <- dengue_2023 %>%\n  filter(epi_week >= 31 & epi_week <= 50)\n```\n:::\n\n\nAccording to (Health Protection Surveillance Centre)\\[https://www.hpsc.ie/notifiablediseases/resources/epidemiologicalweeks/\\], epidemiology weeks 31 to 50 are from 2023-07-30 to 2023-12-16.\n\nThen verify that the earliest and latest date in **tainan_dengue_2023** are 2023-07-30 and 2023-12-16 respectively.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nearliest_date <- min(dengue_study$發病日)\nlatest_date <- max(dengue_study$發病日)\n\nearliest_date == \"2023-07-30\"\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n```{.r .cell-code}\nlatest_date == \"2023-12-16\"\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n::: callout-note\n#### Important\n\nSince it is my first time using the *epiweek()* function, I felt it was important to refer to an official medical source explicitly stating the start and end dates of our interested study period. Hence, I performed a quick test to check if there was any mistake in the usage of this unfamiliar function.\n:::\n\nEarlier, the dengue data type identified was tibble data frame. To perform an intersection between the study area boundary and our dengue study data, `dengue_study` needs to be converted to sf data frame format since `tainan_aoi` is in that format.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(tainan_aoi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"sf\"         \"data.frame\"\n```\n:::\n:::\n\n\nEnsure coordinates are numeric. If not, convert them to numeric.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"character\"\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"character\"\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"numeric\"\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"numeric\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_study_clean  <- dengue_study %>%\n  filter(is.numeric(最小統計區中心點X) & is.numeric(最小統計區中心點Y))\n\nnrow(dengue_study) == nrow(dengue_study_clean)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n::: callout-tip\n#### Learning Point\n\nWhen performing the *as.numeric()* on `dengue_study`, there were no changes in rows. On second thought, the function will not include rows that do not contain numeric characters!\n:::\n\nRemove missing coordinates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_study <- dengue_study %>% \n  filter(!is.na(最小統計區中心點X), !is.na(最小統計區中心點Y))\n```\n:::\n\n\nNow, `dengue_study` can be converted to sf data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue.sf <- st_as_sf(dengue_study, \n                      coords = c(\"最小統計區中心點X\",\"最小統計區中心點Y\"),\n                      crs=3824)\n```\n:::\n\n\nConfine `dengue.sf` into dengue cases recorded in just Tainan City, i.e. 台南市.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naoi_dengue.sf <- subset(dengue.sf, 居住縣市 == \"台南市\")\n```\n:::\n\n\nConsolidate `dengue.sf` and keep the columns that are needed only.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(aoi_dengue.sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"發病日\"             \"個案研判日\"         \"通報日\"            \n [4] \"性別\"               \"年齡層\"             \"居住縣市\"          \n [7] \"居住鄉鎮\"           \"居住村里\"           \"最小統計區\"        \n[10] \"一級統計區\"         \"二級統計區\"         \"感染縣市\"          \n[13] \"感染鄉鎮\"           \"感染村里\"           \"是否境外移入\"      \n[16] \"感染國家\"           \"確定病例數\"         \"居住村里代碼\"      \n[19] \"感染村里代碼\"       \"血清型\"             \"內政部居住縣市代碼\"\n[22] \"內政部居住鄉鎮代碼\" \"內政部感染縣市代碼\" \"內政部感染鄉鎮代碼\"\n[25] \"epi_week\"           \"geometry\"          \n```\n:::\n\n```{.r .cell-code}\naoi_dengue.sf <- aoi_dengue.sf %>%\n  select(發病日, 性別, 年齡層, 感染國家, 確定病例數, epi_week, geometry)\n```\n:::\n\n\nFinally, an intersection between `tainan_aoi` and `aoi_dengue.sf` to confine the dengue cases to the study area can be performed using \\`*st_intersection()*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_crs(tainan_aoi)\nst_crs(aoi_dengue.sf)\naoi_dengue <- st_intersection(tainan_aoi, aoi_dengue.sf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(aoi_dengue, \"data/geospatial/aoi_dengue.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\naoi_dengue <- readRDS(\"data/geospatial/aoi_dengue.rds\")\nclass(aoi_dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"sf\"         \"data.frame\"\n```\n:::\n\n```{.r .cell-code}\nnrow(aoi_dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 18816\n```\n:::\n:::\n\n\n## Aggregating Dengue Data\n\nGet a proper consolidated data set where the dengue cases are sorted by their unique village codes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nv_dengue <- aoi_dengue %>%\n  group_by(VILLCODE) %>%\n  summarise(count = n()) %>%\n  st_drop_geometry()\n\nv_dengue.sf <- left_join(tainan_aoi,v_dengue) %>%\n  select(1, tail(names(.), 2)) %>%\n  complete(VILLCODE, fill = list(count = 0)) %>%\n  st_as_sf()\n```\n:::\n\n\nGet a proper consolidated data set where the dengue cases are sorted by their unique village codes and epidemiology weeks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvw_dengue <- aoi_dengue %>%\n  group_by(VILLCODE, epi_week) %>%\n  summarise(count = n()) %>%\n  st_drop_geometry()\n\nvw_dengue <- left_join(tainan_aoi,vw_dengue) %>%\n  select(1, tail(names(.), 3)) %>%\n  complete(VILLCODE, epi_week = 31:50, fill = list(count = 0)) %>%\n  st_drop_geometry() %>%\n  select(1:3) %>%\n  drop_na()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvw_dengue.sf <- left_join(tainan_aoi, vw_dengue) %>%\n  select(1, tail(names(.), 3)) %>%\n  complete(VILLCODE, epi_week = 31:50, fill = list(count = 0)) %>%\n  st_as_sf()\n\nvw_dengue.sf <- vw_dengue.sf[!is.na(vw_dengue.sf$epi_week), ]\n\nwrite_rds(vw_dengue.sf, \"data/geospatial/vw_dengue.sf\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvw_dengue.sf <- read_rds(\"data/geospatial/vw_dengue.sf\")\n```\n:::\n\n\n# Exploratory Data Analysis\n\nI am interested how the dengue cases are distributed across space and time.\n\nIn general, here is the distribution of dengue cases across ...\n\n## Across Space\n\n::: panel-tabset\n### Barplot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(aoi_dengue, aes(x = TOWNID)) +\n  geom_bar(fill = \"steelblue\", color = \"black\", bins = 20) +\n  geom_text(stat = \"count\", aes(label = ..count..), vjust = -0.5)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n\n```{.r .cell-code}\n  labs(x = \"TOWNID\", y = \"Number of Dengue Cases\", Title = \"Histogram of Dengue cases by District Town\") \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$x\n[1] \"TOWNID\"\n\n$y\n[1] \"Number of Dengue Cases\"\n\n$Title\n[1] \"Histogram of Dengue cases by District Town\"\n\nattr(,\"class\")\n[1] \"labels\"\n```\n:::\n:::\n\n\n### Choropleth Map\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\ntm_shape(v_dengue.sf) +\n  tm_fill(\"count\",\n          style = \"jenks\",\n          title = \"count\") +\n  tm_layout(main.title = \"Distribution of Dengue Cases per Village\",\n            main.title.position = \"center\",\n            main.title.size = 1.2,\n            legend.height = 0.45,\n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_borders(alpha = 0.5) +\n  tm_compass(type=\"8star\", size = 2) +\n  tm_scale_bar() +\n  tm_grid(alpha = 0.2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n:::\n\n### Across Time\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(aoi_dengue, aes(x = epi_week)) +\n  geom_bar(fill = \"blue\", color = \"black\") +\n labs(x = \"Epidemiology Week\", y = \"Count\", title = \"Barplot of Dengue Cases across EWeeks\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n\nFrom **tmap**, *tm_facets()* can be used to split our maps according to epidemiology week.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_anim <- tm_shape(vw_dengue.sf) +\n  tm_fill(\"count\", palette = \"Blues\") +\n  tm_borders(lwd = 0.1) +\n  tm_facets(along = \"epi_week\", free.coords = FALSE)\n\ndengue_anim\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n========\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-5.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-6.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-7.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-8.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-9.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-10.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-11.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-12.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-13.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-14.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-15.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-16.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-17.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-18.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-19.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n====\n```\n:::\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-32-20.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_animation(dengue_anim, filename = \"dengue.gif\", delay = 100, width = 1280, height = 720, scale = 2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::include_graphics(\"dengue.gif\")\n```\n\n::: {.cell-output-display}\n![](dengue.gif)\n:::\n:::\n\n\n# Global Spatial Autocorrelation\n\n## Deriving contiguity weights\n\nEach geometry is defined by a unique village. In order to test for any spatial autocorrelation, spatial weights must be assigned to each of the villages. In a more theoretical context, these villages are neighbours.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue.wm_q <- v_dengue.sf %>%\n  mutate(nb = st_contiguity(geometry),\n         wt = st_weights(nb, style=\"W\"),\n         .before = 1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue.wm_q\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 258 features and 4 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 120.0627 ymin: 22.89401 xmax: 120.2925 ymax: 23.09144\nGeodetic CRS:  TWD97\n# A tibble: 258 × 5\n   nb         wt         VILLCODE    count                              geometry\n * <nb>       <list>     <chr>       <int>                         <POLYGON [°]>\n 1 <int [9]>  <dbl [9]>  67000270001    37 ((120.2672 22.99653, 120.2673 22.996…\n 2 <int [3]>  <dbl [3]>  67000270002    15 ((120.266 22.99104, 120.266 22.99096…\n 3 <int [5]>  <dbl [5]>  67000270003    39 ((120.2492 22.98265, 120.2497 22.982…\n 4 <int [12]> <dbl [12]> 67000270004   105 ((120.2391 22.98008, 120.2393 22.980…\n 5 <int [3]>  <dbl [3]>  67000270005   163 ((120.2578 22.97427, 120.2584 22.973…\n 6 <int [4]>  <dbl [4]>  67000270006    15 ((120.2713 22.96793, 120.2712 22.967…\n 7 <int [5]>  <dbl [5]>  67000270007    41 ((120.2408 22.959, 120.2422 22.95846…\n 8 <int [5]>  <dbl [5]>  67000270008    30 ((120.2701 22.94837, 120.2701 22.948…\n 9 <int [5]>  <dbl [5]>  67000270011    19 ((120.2304 22.93544, 120.2306 22.935…\n10 <int [14]> <dbl [14]> 67000270012    62 ((120.2251 22.96159, 120.2256 22.961…\n# ℹ 248 more rows\n```\n:::\n:::\n\n\n## Global Moran I's Permutation Test\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\nglobal_moran_perm(dengue.wm_q$count,\n                  dengue.wm_q$nb,\n                  dengue.wm_q$wt,\n                  nsim = 99)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tMonte-Carlo simulation of Moran I\n\ndata:  x \nweights: listw  \nnumber of simulations + 1: 100 \n\nstatistic = 0.46837, observed rank = 100, p-value < 2.2e-16\nalternative hypothesis: two.sided\n```\n:::\n:::\n\n\nThere is sufficient statistical evidence to reject the null hypothesis that the spatial distribution of dengue cases in our areas of interest in Tainan city resembles random spatial distribution. Evidently, the Moran's I test statistic is greater than 0 and we can infer that the spatial distribution resembles signs of clustering.\n\n# Local Spatial Autocorrelation\n\n## Computing Local Moran's I\n\nLocal Moran's I is the most popular spatial statistical method to detect for spatial clusters and outliers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa <- dengue.wm_q %>%\n  mutate(local_moran = local_moran(count, nb, wt, nsim = 99),\n         .before = 1) %>%\n  unnest(local_moran)\n```\n:::\n\n\n### Visualising local Moran's I\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\nmap1 <- tm_shape(lisa) +\n  tm_fill(\"ii\") + \n  tm_borders(alpha = 0.5) +\n  tm_view(set.zoom.limits = c(6,8)) +\n  tm_layout(main.title = \"local Moran's I of Dengue Cases\",\n            main.title.size = 0.8)\n\nmap1\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n\n\n### Visualising local Moran's I\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\nmap2 <- tm_shape(lisa) +\n  tm_fill(\"p_ii_sim\") + \n  tm_borders(alpha = 0.5) +\n   tm_layout(main.title = \"p-value of local Moran's I\",\n            main.title.size = 0.8)\n\nmap2\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-40-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\n\ntmap_arrange(map1, map2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n\n<Analysis here>\n\n### Visualising LISA map\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa_sig <- lisa  %>%\n  filter(p_ii < 0.05)\n\nlisa_map <- \ntm_shape(lisa) +\n  tm_polygons() +\n  tm_borders(alpha = 0.5) +\ntm_shape(lisa_sig) +\n  tm_fill(\"mean\") + \n  tm_borders(alpha = 0.4) +\n  tm_scale_bar() +\n  tm_layout(legend.show = TRUE, main.title = \"Overview of Outliers and Clusters\", main.title.size = 1)\n\ntmap_mode(\"plot\")\ntmap_arrange(lisa_map, secondary_map, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-42-1.png){width=672}\n:::\n:::\n\n\nThe northwest and central-southeast villages of our Tainan area of interest have been identified as low-low clusters, thus their neighbours have had low-values or cases in general across the weeks.\n\nInterestingly, high-high clusters are found along the most part of a radial perimeter 3km away from the centre of the study area. These high-high clusters lie in Towns D06, D39, D01 and D02.\n\n## Computing Local Gi\\* Values Across Time\n\n### Creating Time Series Cube\n\nUse \\*spacetime() of **sfdep** package to create a spatio-temporal cube.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntn_st <- spacetime(vw_dengue, tainan_aoi, \n                   .loc_col = \"VILLCODE\",\n                   .time_col = \"epi_week\",\n                   active = \"data\")\n\nis_spacetime_cube(tn_st)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n## Deriving Spatial Weights\n\nCompute spatial weights by deriving inverse distance weights to compute the Gi\\* statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntn_nb <- tn_st %>%\n  activate(\"geometry\") %>%\n  mutate(nb = include_self(st_contiguity(geometry)),\n         wt = st_inverse_distance(nb, geometry,\n                                  scale = 1,\n                                  alpha = 1),\n         .before = 1) %>%\n  set_nbs(\"nb\") %>%\n  set_wts(\"wt\")\n```\n:::\n\n\nNow each time-sliced village has neighbours and weights.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(tn_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 5\n  VILLCODE    epi_week count nb        wt       \n  <chr>          <dbl> <int> <list>    <list>   \n1 67000350032       31     0 <int [4]> <dbl [4]>\n2 67000270011       31     1 <int [6]> <dbl [6]>\n3 67000370005       31     0 <int [9]> <dbl [9]>\n4 67000330004       31     0 <int [7]> <dbl [7]>\n5 67000350028       31     0 <int [5]> <dbl [5]>\n6 67000350030       31     0 <int [8]> <dbl [8]>\n```\n:::\n:::\n\n\nThe neighbour `nb` and weights `wt` have been calculated\n\n## Computation of Gi\\*\n\nUse *local_gstar_perm()* of **sfdep** package and group by `epi_week` to manually calculate the local GI\\* statistic for each village `VILLCODE`. After which, use unnest() to unnest the gi_star column of the new dataframe.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngistars <- tn_nb %>%\n  group_by(epi_week) %>%\n  mutate(gi_star = local_gstar_perm(count, nb, wt)) %>%\n  unnest(gi_star)\n```\n:::\n\n\nWith the statistic, we can merge our geometry to plot and see the statistical trends of the local GI\\* statistic\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngistar_map <- left_join(tainan_aoi, gistars,\n                          by = c(\"VILLCODE\" = \"VILLCODE\"))\n```\n:::\n\n\nCreate the tmap plot for the `gi_star` statistic.\n\n::: {callout-note}\nUse p_sim to use the simulated values and use fixed style and breaks to plot the values that were P \\< 0.05 which are areas that are significant.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngistar_map <- gistar_map %>% mutate(`P-Value` = case_when(p_sim < 0.05 ~ '< 0.05',  p_sim >= 0.05 ~ 'Not-Significant'))\n\ngistar_tmap <-\n  tm_shape(gistar_map) + \n    tm_fill(\"P-Value\") +\n    tm_borders(lwd = 0.1) +\n    tm_facets(along = \"epi_week\", free.coords = FALSE) + \n  tm_scale_bar()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_animation(gistar_tmap, filename = \"gistar.gif\", delay = 100, width = 1280, height = 720, scale = 2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::include_graphics(\"gistar.gif\")\n```\n\n::: {.cell-output-display}\n![](gistar.gif)\n:::\n:::\n\n\nVillages in light blue mean that the p-value is less than 0.05, indicating that they are significantly associated with higher OR lower dengue cases compared to their neighbouring villages.\n\nGenerally, there are different significant areas across the study period.\n\nThe north western region of our study area in Tainan appears to be significant from epidemiology weeks 36 to 46.\n\nTo have a closer analysis on the significant areas, an emerging hot spot analysis can further conclude the observations.\n\n# Hot Spot and Cold Spot Area Analysis\n\nHot spot analysis utilises Getis-Ord or Gi\\* statistics where they are, by extension, local indicators of spatial association. More information can be found from Josiah Parry's succinct explanation on the fundamentals of hot spot analysis (here)\\[https://www.youtube.com/watch?v=sjLyJW95fHM\\]. (He is also the author of the sfdep pacakge!)\n\n## Computation of local Gi\\*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwm_idw <- v_dengue.sf %>%\n  mutate(nb = st_contiguity(geometry),\n         wts = st_inverse_distance(nb, geometry,\n         scale = 1,\n         alpha = 1),\n.before = 1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nHCSA <- wm_idw %>% \n  mutate(local_Gi = local_gstar_perm(\n    count, nb, wt, nsim = 99),\n         .before = 1) %>%\n  unnest(local_Gi)\nHCSA\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 258 features and 12 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 120.0627 ymin: 22.89401 xmax: 120.2925 ymax: 23.09144\nGeodetic CRS:  TWD97\n# A tibble: 258 × 13\n   gi_star    e_gi    var_gi p_value  p_sim p_folded_sim skewness kurtosis nb   \n     <dbl>   <dbl>     <dbl>   <dbl>  <dbl>        <dbl>    <dbl>    <dbl> <nb> \n 1 -0.996  0.00365   1.05e-6 -0.725  0.469          0.56     0.28    0.449 <int>\n 2 -1.16   0.00319   1.68e-6 -0.852  0.394          0.4      0.2     0.237 <int>\n 3 -0.124  0.00368   1.54e-6  0.0326 0.974          0.84     0.42    0.597 <int>\n 4  1.04   0.00393   6.82e-7  0.998  0.318          0.22     0.11    1.11  <int>\n 5  0.260  0.00502   1.74e-6 -0.562  0.574          0.6      0.3     0.635 <int>\n 6 -0.0819 0.00339   1.61e-6  0.295  0.768          0.68     0.34    0.574 <int>\n 7 -1.24   0.00351   1.25e-6 -1.08   0.282          0.26     0.13    0.683 <int>\n 8 -2.19   0.00347   1.51e-6 -1.91   0.0558         0.04     0.02    0.644 <int>\n 9 -2.05   0.00348   1.47e-6 -1.80   0.0721         0.08     0.04    0.305 <int>\n10 -2.37   0.00383   6.04e-7 -2.33   0.0196         0.02     0.01    0.516 <int>\n# ℹ 248 more rows\n# ℹ 4 more variables: wts <list>, VILLCODE <chr>, count <int>,\n#   geometry <POLYGON [°]>\n```\n:::\n:::\n\n\n### Visualising Gi\\*\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\ntm_shape(HCSA) +\n  tm_fill(\"gi_star\") + \n  tm_borders(alpha = 0.5) +\n  tm_view(set.zoom.limits = c(6,8))\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-53-1.png){width=672}\n:::\n:::\n\n\n### Visualising p-value of HCSA\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\ntm_shape(HCSA) +\n  tm_fill(\"p_sim\") + \n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-54-1.png){width=672}\n:::\n:::\n\n\n### Visualising Local HCSA\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_mode(\"plot\")\nmap1 <- tm_shape(HCSA) +\n  tm_fill(\"gi_star\") + \n  tm_borders(alpha = 0.5) +\n  tm_view(set.zoom.limits = c(6,8)) +\n  tm_layout(main.title = \"Gi* of Dengue Case Count\",\n            main.title.size = 0.8)\n\nmap2 <- tm_shape(HCSA) +\n  tm_fill(\"p_value\",\n          breaks = c(0, 0.001, 0.01, 0.05, 1),\n              labels = c(\"0.001\", \"0.01\", \"0.05\", \"Not sig\")) + \n  tm_borders(alpha = 0.5) +\n  tm_layout(main.title = \"p-value of Gi*\",\n            main.title.size = 0.8)\n\ntmap_arrange(map1, map2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-55-1.png){width=672}\n:::\n:::\n\n\n### Visualising hot & cold spot areas\n\n::: {.cell}\n\n```{.r .cell-code}\nHCSA_sig <- HCSA  %>%\n  filter(p_sim < 0.05)\ntmap_mode(\"plot\")\ntm_shape(HCSA) +\n  tm_polygons() +\n  tm_borders(alpha = 0.5) +\ntm_shape(HCSA_sig) +\n  tm_fill(\"gi_star\") + \n  tm_borders(alpha = 0.4)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-56-1.png){width=672}\n:::\n:::\n\n\n## Mann-Kendall Test and Gi\\*\n\nFirst, locations can be evaluated through the Mann-Kendall test. This non-parametric test assesses if a set of data values is increasing or decreasing over time and also if the direction of the trend is statistically significant.\n\nThe *MannKendall()* function is to identify whether the dengue cases are growing or decreasing with time.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nehsa <- gistars %>%\n  group_by(VILLCODE) %>%\n  summarise(mk = list(\n    unclass(\n      Kendall::MannKendall(gi_star)))) %>%\n  unnest_wider(mk)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngistars_merged <- merge(gistars, tainan_aoi[c(\"VILLCODE\", \"VILLENG\", \"TOWNID\", \"TOWNNAME\")], by = \"VILLCODE\", all.x = TRUE)\n```\n:::\n\n\nTo have a look at all the Gi\\* statistics across all the villages, the following function can be used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunique_villeng <- unique(gistars_merged$VILLENG)\n\ncreate_plot <- function(villeng) {\n  cbg <- gistars_merged %>%\n    ungroup() %>%\n    filter(VILLENG == villeng) %>%\n    select(VILLENG, epi_week, gi_star)\n  \n  ggplot(data = cbg, aes(x = epi_week, y = gi_star)) +\n    geom_line() +\n    theme_light() +\n    ggtitle(paste(\"VILLENG:\", villeng))\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplots_list <- map(unique_villeng, create_plot)\nplots_list\nwrite_rds(plots_list, \"gistars_plots\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplots_list <- read_rds(\"gistars_plots\")\n```\n:::\n\n\n::: callout-warning\nSince the above two code chunks requires a lot of computation time, I have saved `plots_list` as a rds file.\n:::\n\nThere are some Gi\\* graphs of some villages that caught my attention. So let's plot them out.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterested_vills <- c(\"Fuqian Vil.\", \"Nanhua Vil.\", \"Shenggong Vil.\")\n\nvills_filtered <- tainan_aoi %>%\n  mutate(highlight = ifelse(VILLENG %in% interested_vills, \"Intersting\", \"NA\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(vills_filtered) +\n  tm_polygons(\"highlight\", palette = c(\"red\",\"grey\")) +\n  tm_borders(lwd = 0.2, alpha = 1) +\n  tm_layout(main.title = \"Overview of Initial Interested Villages\", main.title.size = 1) +\n  tm_scale_bar()\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-63-1.png){width=672}\n:::\n:::\n\n\n::: callout-note\n### What is a Census Block Group?\n\nIt is a unit of census geography that is a combination of census blocks typically used in the (United States)\\[https://support.esri.com/en-us/gis-dictionary/block-group\\]. However, another such of a unit of measurement is not available globally, hence I employ census block group for easier reference.\n:::\n\n### Initial census block groups.\n\n::: panel-tabset\n#### Shenggong Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_sg <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Shenggong Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n\n#### Nanhua Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_nh <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Nanhua Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n\n#### Fuqian Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_fq <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Fuqian Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n:::\n\n### Gi\\* Temporal Trends\n\nHypothesis:\n\nH0: There is no monotonic time-series trend.\n\nH1: A positive, negative or non-null trend exists.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_sg, mapping = aes(x = epi_week, y = gi_star, color = \"Shenggong Village\")) +\n  geom_line(data = cbg_nh, mapping = aes(x = epi_week, y = gi_star, color = \"Nanhua Village\")) + \n  geom_line(data = cbg_fq, mapping = aes(x = epi_week, y = gi_star, color = \"Fuqian Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for 3 villages\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-67-1.png){width=672}\n:::\n:::\n\n\nLet's check these villages and the significance of the local dengue cases over time.\n\n::: panel-tabset\n#### Shenggong Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_sg %>%\n  summarise(mk = list(\n    unclass(\n      Kendall::MannKendall(gi_star)))) %>% \n  tidyr::unnest_wider(mk)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 5\n     tau    sl     S     D  varS\n   <dbl> <dbl> <dbl> <dbl> <dbl>\n1 -0.126 0.456   -24  190.   950\n```\n:::\n:::\n\n\n#### Nanhua Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_nh %>%\n  summarise(mk = list(\n    unclass(\n      Kendall::MannKendall(gi_star)))) %>% \n  tidyr::unnest_wider(mk)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 5\n      tau    sl     S     D  varS\n    <dbl> <dbl> <dbl> <dbl> <dbl>\n1 -0.0211 0.922    -4  190.   950\n```\n:::\n:::\n\n\n#### Fuqian Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_fq %>%\n  summarise(mk = list(\n    unclass(\n      Kendall::MannKendall(gi_star)))) %>% \n  tidyr::unnest_wider(mk)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 5\n    tau    sl     S     D  varS\n  <dbl> <dbl> <dbl> <dbl> <dbl>\n1     0     1     0  190.   950\n```\n:::\n:::\n\n:::\n\nAll the villages that caught my attention with my naked eye have insignificant time-series trends for their dengue cases.\n\nLet's check out where are the locations with significant time-series trends!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter_vill <- function(data) {\n  result <- data %>%\n    group_by(VILLENG) %>%\n    summarise(mk = list(unclass(Kendall::MannKendall(gi_star)))) %>%\n    tidyr::unnest_wider(mk) %>%\n    filter(sl < 0.05)\n  \n  return(result)\n}\n\nsig_vills <- filter_vill(gistars_merged)\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 21 × 6\n   VILLENG           tau       sl     S     D  varS\n   <chr>           <dbl>    <dbl> <dbl> <dbl> <dbl>\n 1 Huaping Vil.   -0.505 0.00205    -96  190.  950 \n 2 Jiading Vil.   -0.463 0.00476    -88  190.  950 \n 3 Haidong Vil.   -0.442 0.00708    -84  190.  950 \n 4 Zhuxi Vil.     -0.421 0.0104     -80  190.  950 \n 5 Wennan Vil.    -0.395 0.000348  -308  780  7367.\n 6 Dongqiao Vil.  -0.389 0.0179     -74  190.  950 \n 7 Lixing Vil.    -0.379 0.0212     -72  190.  950 \n 8 Guangzhou Vil. -0.347 0.0350     -66  190.  950 \n 9 Xiaoximen Vil. -0.326 0.0478     -62  190.  950 \n10 Ren'ai Vil.     0.292 0.00817    228  780  7367.\n# ℹ 11 more rows\n```\n:::\n:::\n\n\nFrom the results above, we can observe that about 8.43% of all the villages (21 of 249) in the study area only possess significant trends denoted by a p-value (sl) of less than 0.05.\n\nThe greatest downward and upward trends in dengue cases were exhibited in Huaping Village and Chenggong Village respectively according to their tau values.\n\n### Significant Census Block Groups\n\n::: panel-tabset\n#### Huaping Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_hp <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Huaping Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_hp, mapping = aes(x = epi_week, y = gi_star, color = \"Huaping Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Huaping Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-74-1.png){width=672}\n:::\n:::\n\n\n#### Jiading Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_jd <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Jiading Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_jd, mapping = aes(x = epi_week, y = gi_star, color = \"Jiading Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Jiading Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-76-1.png){width=672}\n:::\n:::\n\n\n#### Chenggong Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_cg <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Chenggong Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_cg, mapping = aes(x = epi_week, y = gi_star, color = \"Chenggong Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Chenggong Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-78-1.png){width=672}\n:::\n:::\n\n\n#### Xidong Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_xd <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Xidong Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_xd, mapping = aes(x = epi_week, y = gi_star, color = \"Xidong Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Xidong Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-80-1.png){width=672}\n:::\n:::\n\n\n#### Ren'ai Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_ra <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Ren'ai Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_ra, mapping = aes(x = epi_week, y = gi_star, color = \"Ren'ai Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Ren'ai Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-82-1.png){width=672}\n:::\n:::\n\n\n#### Xiaoximen Village\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbg_xm <- gistars_merged %>%\n  ungroup() %>%\n  filter(VILLENG == \"Xiaoximen Vil.\") |>\n  select(VILLENG, epi_week, gi_star)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_line(data = cbg_xm, mapping = aes(x = epi_week, y = gi_star, color = \"Xiaoximen Village\")) +\n  labs(x = \"Epi Week\", y = \"Gi* Value\", \n       title = \"Gi* over time for Xiaoximen Village\",\n       color = \"Village\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-84-1.png){width=672}\n:::\n:::\n\n:::\n\nXiaoximen increased the most from epidemiology week 31 to 50 in Gi\\* value. This similar increasing trend was also observed by Huaping. By interpretation and looking at its graph, Xiaoximen village and Xiaoximen village were initially a coldspot area associated with relatively low dengue cases in its surrounding villages. However, the villages became a hotspot associated with relatively high dengue cases in its surrounding villages.In essence, Xiaoximen and its neighbours were more infected as a cluster over time.\n\nChenggong and Ren'ai villages were seen to be oscillating coldspots across the weeks, where their Gi\\* values were oscillating within the negative range of Gi\\*.\n\n## Emerging Hotspot Analysis\n\nFrom the **sfdep** package, *emerging_hotspot_analysis()* can be used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nehsa <- emerging_hotspot_analysis(\n  x = tn_st,\n  .var = \"count\",\n  k = 1,\n  nsim = 99\n)\n```\n:::\n\n\n-   The k argument is used to specify the number of time lags which is set to 1 by default.\n\nTo view the distribution of EHSA classes, we can use *ggplot()*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = ehsa,\n       aes(x = classification)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-86-1.png){width=672}\n:::\n:::\n\n\n### Visualising EHSA\n\nCurrently, `ehsa` does not have any spatial characteristic. Hence it needs to join with `tainan_aoi` to obtain the geospatial characteristics.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntn_ehsa <- tainan_aoi %>%\n  left_join(ehsa,\n            by = join_by(VILLCODE == location))\n```\n:::\n\n\nFilter for significant locations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nehsa_sig <- tn_ehsa %>%\n  filter(p_value < 0.05)\n\nehsa_sig_map <- tm_shape(tn_ehsa) +\n  tm_polygons() +\n  tm_borders(alpha = 0.5) +\ntm_shape(ehsa_sig) +\n  tm_fill(\"classification\") + \n  tm_borders(alpha = 0.4) +\n  tm_scale_bar()\n\nehsa_sig_map\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02a_files/figure-html/unnamed-chunk-88-1.png){width=672}\n:::\n:::\n\n\nIn general, most of the study area is characterised by hotspots rather than coldspots. There are a significant number of oscilating hotspots in the study area.\n\nIn total, eight villages had no detected patterns.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter(tn_ehsa, classification == \"no pattern detected\")$VILLENG\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Chengbei Vil.\" \"Chengnan Vil.\" \"Xiding Vil.\"   \"Yuping Vil.\"  \n[5] \"Shanglun Vil.\" \"Anshun Vil.\"   \"Zhonghua Vil.\"\n```\n:::\n:::\n\n\nTwo new hotspots were detected.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter(tn_ehsa, classification == \"new hotspot\")$VILLENG\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ncharacter(0)\n```\n:::\n:::\n\n\n# Conclusion\n\nThere is spatial randomness in the dengue cases across the study area of Tainan and the epidemiology weeks.\n",
    "supporting": [
      "Take-home_Ex02a_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}